<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <title>Admin Panel â€“ LA Incident Map</title>
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <style>
    body { font-family: sans-serif; margin: 2em; }
    h1 { margin-bottom: 0.5em; }
    .hidden { display: none; }
    label, input, select, button { display: block; margin-top: 0.5em; }
    table { margin-top: 2em; border-collapse: collapse; width: 100%; }
    th, td { border: 1px solid #ccc; padding: 8px; }
    tr:nth-child(even) { background: #f9f9f9; }
  </style>
</head>
<body>
  <h1>Admin Dashboard</h1>

  <div id="auth-section">
    <h2>Login</h2>
    <input id="email" type="email" placeholder="Email">
    <input id="password" type="password" placeholder="Password">
    <button onclick="login()">Login</button>
  </div>

  <div id="admin-section" class="hidden">
    <p>Logged in as <span id="user-email"></span> | <button onclick="logout()">Logout</button></p>

    <h2>Add New Incident</h2>
    <form onsubmit="addIncident(event)">
      <label>Type:
        <select id="type">
          <option value="riot">Riot</option>
          <option value="fire">Fire</option>
          <option value="gunshot">Gunshot</option>
        </select>
      </label>
      <label>Latitude: <input id="lat" type="number" step="0.00001" required></label>
      <label>Longitude: <input id="lng" type="number" step="0.00001" required></label>
      <label>Street Name: <input id="street" type="text" required></label>
      <label>News Source URL: <input id="source" type="url" required></label>
      <button type="submit">Add Incident</button>
    </form>

    <h2>Existing Incidents</h2>
    <table>
      <thead>
        <tr><th>Type</th><th>GPS</th><th>Street</th><th>Source</th><th>Action</th></tr>
      </thead>
      <tbody id="incident-table"></tbody>
    </table>
  </div>

  <!-- Supabase -->
  <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2.43.3/dist/umd/supabase.min.js"></script>
  <script>
    const SUPABASE_URL = "{{ SUPABASE_URL }}";
    const SUPABASE_ANON_KEY = "{{ SUPABASE_ANON_KEY }}";
    const supabase = supabase.createClient(SUPABASE_URL, SUPABASE_ANON_KEY);
	
	console.log("Supabase initialized");

    async function login() {
      const email = document.getElementById("email").value;
      const password = document.getElementById("password").value;
      const { data, error } = await supabase.auth.signInWithPassword({ email, password });
      if (error) {
        alert("Login failed: " + error.message);
        return;
      }
      document.getElementById("auth-section").classList.add("hidden");
      document.getElementById("admin-section").classList.remove("hidden");
      document.getElementById("user-email").textContent = data.user.email;
      loadIncidents();
    }

    async function logout() {
      await supabase.auth.signOut();
      location.reload();
    }

    async function addIncident(event) {
      event.preventDefault();
      const type = document.getElementById("type").value;
      const lat = parseFloat(document.getElementById("lat").value);
      const lng = parseFloat(document.getElementById("lng").value);
      const street = document.getElementById("street").value;
      const source_url = document.getElementById("source").value;

      const { error } = await supabase.from("incidents").insert([{ type, lat, lng, street, source_url }]);
      if (error) {
        alert("Error adding incident: " + error.message);
      } else {
        alert("Incident added.");
        loadIncidents();
      }
    }

    async function deleteIncident(id) {
      if (!confirm("Are you sure you want to delete this incident?")) return;
      const { error } = await supabase.from("incidents").delete().eq("id", id);
      if (error) {
        alert("Error deleting: " + error.message);
      } else {
        alert("Deleted.");
        loadIncidents();
      }
    }

    async function loadIncidents() {
      const { data, error } = await supabase.from("incidents").select("*").order("created_at", { ascending: false });
      const table = document.getElementById("incident-table");
      table.innerHTML = "";
      data.forEach(incident => {
        const row = document.createElement("tr");
        row.innerHTML = `
          <td>${incident.type}</td>
          <td>${incident.lat.toFixed(5)}, ${incident.lng.toFixed(5)}</td>
          <td>${incident.street}</td>
          <td><a href="${incident.source_url}" target="_blank">link</a></td>
          <td><button onclick="deleteIncident('${incident.id}')">Delete</button></td>
        `;
        table.appendChild(row);
      });
    }

    // Auto-login if already signed in
    supabase.auth.getUser().then(({ data }) => {
      if (data.user) {
        document.getElementById("auth-section").classList.add("hidden");
        document.getElementById("admin-section").classList.remove("hidden");
        document.getElementById("user-email").textContent = data.user.email;
        loadIncidents();
      }
    });
  </script>
</body>
</html>
